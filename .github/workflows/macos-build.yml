name: macOS DMG build

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Build binary and DMG (inline)
        shell: bash
        run: |
          set -euxo pipefail

          APP_NAME="IPDelister"
          ENTRY="main.py"
          DMG_NAME="${APP_NAME}-macOS.dmg"
          STAGE_ROOT=".dmg-stage"
          APP_DIR="$STAGE_ROOT/${APP_NAME}"

          python3 -m pip install --upgrade pip wheel
          pip install -r requirements.txt
          pip install pyinstaller

          # onefile binary
          pyinstaller "$ENTRY" --name "$APP_NAME" --onefile --noconfirm --clean
          test -f "dist/${APP_NAME}"

          # stage: одна папка IPDelister/ внутри DMG
          rm -rf "$STAGE_ROOT"
          mkdir -p "$APP_DIR"
          cp "dist/${APP_NAME}" "$APP_DIR/${APP_NAME}"

          # запускалка рядом с бинарём
          cat > "$APP_DIR/Run ${APP_NAME}.command" <<'EOF'
          #!/bin/bash
          set -e
          DIR="$(cd "$(dirname "$0")" && pwd)"
          if [[ ! -x "$DIR/IPDelister" ]]; then
            osascript -e 'display alert "IPDelister не найден" message "Положите Run IPDelister.command и IPDelister в одну папку."'
            exit 1
          fi
          "$DIR/IPDelister"
          echo
          read -n 1 -s -r -p "Press any key to close..."
          EOF
          chmod +x "$APP_DIR/Run ${APP_NAME}.command"
          chmod +x "$APP_DIR/${APP_NAME}"

          # опционально README и пример
          [ -f "README.md" ] && cp "README.md" "$APP_DIR/README.md"
          [ -f "ip.txt" ] && cp "ip.txt" "$APP_DIR/ip.example.txt"

          # собираем DMG из корня .dmg-stage (внутри лежит папка IPDelister/)
          hdiutil create -volname "$APP_NAME" -srcfolder "$STAGE_ROOT" -ov -format UDZO "$DMG_NAME"

          rm -rf "$STAGE_ROOT"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: IPDelister-macOS
          path: |
            IPDelister-macOS.dmg
            dist/IPDelister
